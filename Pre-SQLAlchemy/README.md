# Python adapters for PostgreSQL review

## Abstracts

Здесь дано краткое описание архитектуры взаимодействия RDBMS PostgreSQL с клиентом, в роли которого выступает адаптер.

## Table of Contents

- [Description](#description)
- [References](#References)
- [Annex A: Schema](#annex-a)
- [Annex B: psycopg3 vs asyncpg](#annex-b)

## Description

1. PostgreSQL взаимодействует с клиентом посредством сообщений сформированных в соответствии с клиентским протоколом (PostgreSQL Wire Protocol), который определяет:

   - Формат клиентских и серверных сообщений
   - Команды и типы ответов
   - Механизм установления, поддержания и закрытия соединений
   - Правила кодирования типов данных
   - Формат сообщений об ошибках и исключениях

1. libpq - это официальная C‑библиотека от разработчиков PostgreSQL, реализующая поддержку PostgreSQL Wire Protocol

   - Реализует Wire Protocol на низком уровне
   - Поддерживает SSL, пул соединений, аутентификацию
   - Является «движком» для многих клиентских драйверов (включая psycopg2)

1. DB API 2.0 (Python database API specification 2.0)

   - Python-спецификация (PEP249) которая определяет, каким должен быть интерфейс для работы с базой данных

1. psycopg2 - самый популярный адаптер для python

   - Представляет из себя обёртку над libpq
   - Полностью соотвествует DB API 2.0
   - поддерживает расширенные типы PostgreSQL (массивы, JSON, UUID)

1. Асинхронность в psycopg2

   - Хотя в документации для psycopg2 указано asynchronous communication, на практике она почти никогда не используется
   - Это происходит потому, что у psycopg2 нет удобного уровня абстракции для этого и асинхронными запросами приходится управлять вручную

1. Для асинхронного взаимодействия с PostgreSQL используется asyncpg (или psycopg3)

   - asyncpg не является реализацией DB API (PEP249) и не использует libpq
   - напрямую работает с Wire Protocol
   - оптимизирован для asyncio (неблокирующие операции, пул соединений)

## References

[PostgreSQL Wire Protocol docs](https://www.postgresql.org/docs/current/protocol.html)\
[libpq docs](https://www.postgresql.org/docs/current/libpq.html)\
[DB API PEP249 spec](https://peps.python.org/pep-0249/)\
[psycopg2 docs](https://www.psycopg.org/docs/index.html)\
[psycopg3 docs](https://www.psycopg.org/psycopg3/)\
[asyncpg docs](https://magicstack.github.io/asyncpg/current/)

## Annex A

![schema](./images/schema.svg)

## Annex B

| Критерий | psycopg3 | asyncpg |
|-------------------------|----------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| Интеграция с SQLAlchemy | Поддерживается через асинхронные возможности, но требует более сложной настройки | Оптимизирован для асинхронной работы с SQLAlchemy, часто используется в современных проектах |
| Производительность | Обычно уступает asyncpg в асинхронных сценариях | Считается более производительным благодаря нативной реализации асинхронных операций и оптимизации для PostgreSQL. |
| Совместимость с DB-API | Соответствует PEP 249 (DB-API) | Не реализует DB-API, имеет собственный API |
| Использование | Подходит для проектов, где важна совместимость с синхронным кодом или требуется гибкость настройки | Рекомендуется для высоконагруженных асинхронных приложений, где критична скорость |
